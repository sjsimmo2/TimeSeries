<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Dynamic Regression | Time Series 1</title>
  <meta name="description" content="Chapter 6 Dynamic Regression | Time Series 1" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Dynamic Regression | Time Series 1" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Dynamic Regression | Time Series 1" />
  
  
  

<meta name="author" content="by Dr. Susan Simmons" />


<meta name="date" content="2025-11-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="seasonal-arima.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TimeSeries</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Time series</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#other-plots"><i class="fa fa-check"></i><b>2.1</b> Other plots</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#time-series-decomposition"><i class="fa fa-check"></i><b>2.2</b> Time series decomposition</a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#stl-features"><i class="fa fa-check"></i><b>2.3</b> STL features</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#missing-values"><i class="fa fa-check"></i><b>2.4</b> Missing values</a></li>
<li class="chapter" data-level="2.5" data-path="introduction.html"><a href="introduction.html#python-code-and-results-for-time-series-plot"><i class="fa fa-check"></i><b>2.5</b> Python code and results for Time Series plot</a></li>
<li class="chapter" data-level="2.6" data-path="introduction.html"><a href="introduction.html#sas-code-for-time-series-plot-and-decomposition"><i class="fa fa-check"></i><b>2.6</b> SAS code for time series plot and decomposition</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html"><i class="fa fa-check"></i><b>3</b> Exponential Smoothing</a>
<ul>
<li class="chapter" data-level="3.1" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#simple-exponential-smoothing"><i class="fa fa-check"></i><b>3.1</b> Simple Exponential Smoothing</a></li>
<li class="chapter" data-level="3.2" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#holt-esm"><i class="fa fa-check"></i><b>3.2</b> Holt ESM</a></li>
<li class="chapter" data-level="3.3" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#holt-winters"><i class="fa fa-check"></i><b>3.3</b> Holt-Winters</a></li>
<li class="chapter" data-level="3.4" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#comparing-forecasts"><i class="fa fa-check"></i><b>3.4</b> Comparing forecasts</a></li>
<li class="chapter" data-level="3.5" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#ets"><i class="fa fa-check"></i><b>3.5</b> ETS</a></li>
<li class="chapter" data-level="3.6" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#python-code-for-exponential-smoothing"><i class="fa fa-check"></i><b>3.6</b> Python Code for Exponential Smoothing</a></li>
<li class="chapter" data-level="3.7" data-path="exponential-smoothing.html"><a href="exponential-smoothing.html#sas-code-for-exponential-smoothing-models"><i class="fa fa-check"></i><b>3.7</b> SAS Code for Exponential Smoothing Models</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="arima.html"><a href="arima.html"><i class="fa fa-check"></i><b>4</b> ARIMA</a>
<ul>
<li class="chapter" data-level="4.1" data-path="arima.html"><a href="arima.html#stationarity"><i class="fa fa-check"></i><b>4.1</b> Stationarity</a></li>
<li class="chapter" data-level="4.2" data-path="arima.html"><a href="arima.html#correlation-functions"><i class="fa fa-check"></i><b>4.2</b> Correlation Functions</a></li>
<li class="chapter" data-level="4.3" data-path="arima.html"><a href="arima.html#autoregressive-models-ar"><i class="fa fa-check"></i><b>4.3</b> AutoRegressive Models (AR)</a></li>
<li class="chapter" data-level="4.4" data-path="arima.html"><a href="arima.html#moving-average-model-ma"><i class="fa fa-check"></i><b>4.4</b> Moving Average model (MA)</a></li>
<li class="chapter" data-level="4.5" data-path="arima.html"><a href="arima.html#white-noise"><i class="fa fa-check"></i><b>4.5</b> White noise</a></li>
<li class="chapter" data-level="4.6" data-path="arima.html"><a href="arima.html#examples"><i class="fa fa-check"></i><b>4.6</b> Examples</a></li>
<li class="chapter" data-level="4.7" data-path="arima.html"><a href="arima.html#forecasting"><i class="fa fa-check"></i><b>4.7</b> Forecasting</a></li>
<li class="chapter" data-level="4.8" data-path="arima.html"><a href="arima.html#trend"><i class="fa fa-check"></i><b>4.8</b> Trend</a></li>
<li class="chapter" data-level="4.9" data-path="arima.html"><a href="arima.html#python-code-for-armaarima-models"><i class="fa fa-check"></i><b>4.9</b> Python Code for ARMA/ARIMA models</a></li>
<li class="chapter" data-level="4.10" data-path="arima.html"><a href="arima.html#sas-code-for-armaarima"><i class="fa fa-check"></i><b>4.10</b> SAS Code for ARMA/ARIMA</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="seasonal-arima.html"><a href="seasonal-arima.html"><i class="fa fa-check"></i><b>5</b> Seasonal ARIMA</a>
<ul>
<li class="chapter" data-level="5.1" data-path="seasonal-arima.html"><a href="seasonal-arima.html#seasonality"><i class="fa fa-check"></i><b>5.1</b> Seasonality</a></li>
<li class="chapter" data-level="5.2" data-path="seasonal-arima.html"><a href="seasonal-arima.html#seasonal-unit-root-testing"><i class="fa fa-check"></i><b>5.2</b> Seasonal “Unit-Root” Testing</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="seasonal-arima.html"><a href="seasonal-arima.html#r"><i class="fa fa-check"></i><b>5.2.1</b> R</a></li>
<li class="chapter" data-level="5.2.2" data-path="seasonal-arima.html"><a href="seasonal-arima.html#python"><i class="fa fa-check"></i><b>5.2.2</b> Python</a></li>
<li class="chapter" data-level="5.2.3" data-path="seasonal-arima.html"><a href="seasonal-arima.html#sas"><i class="fa fa-check"></i><b>5.2.3</b> SAS</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="seasonal-arima.html"><a href="seasonal-arima.html#deterministic-solution"><i class="fa fa-check"></i><b>5.3</b> Deterministic Solution</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="seasonal-arima.html"><a href="seasonal-arima.html#r-1"><i class="fa fa-check"></i><b>5.3.1</b> R</a></li>
<li class="chapter" data-level="5.3.2" data-path="seasonal-arima.html"><a href="seasonal-arima.html#python-1"><i class="fa fa-check"></i><b>5.3.2</b> Python</a></li>
<li class="chapter" data-level="5.3.3" data-path="seasonal-arima.html"><a href="seasonal-arima.html#sas-1"><i class="fa fa-check"></i><b>5.3.3</b> SAS</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="seasonal-arima.html"><a href="seasonal-arima.html#fourier-transformations"><i class="fa fa-check"></i><b>5.4</b> Fourier Transformations</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="seasonal-arima.html"><a href="seasonal-arima.html#r-2"><i class="fa fa-check"></i><b>5.4.1</b> R</a></li>
<li class="chapter" data-level="5.4.2" data-path="seasonal-arima.html"><a href="seasonal-arima.html#python-2"><i class="fa fa-check"></i><b>5.4.2</b> Python</a></li>
<li class="chapter" data-level="5.4.3" data-path="seasonal-arima.html"><a href="seasonal-arima.html#sas-2"><i class="fa fa-check"></i><b>5.4.3</b> SAS</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="seasonal-arima.html"><a href="seasonal-arima.html#other-predictor-variables"><i class="fa fa-check"></i><b>5.5</b> Other Predictor Variables</a></li>
<li class="chapter" data-level="5.6" data-path="seasonal-arima.html"><a href="seasonal-arima.html#stochastic-solution"><i class="fa fa-check"></i><b>5.6</b> Stochastic Solution</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="seasonal-arima.html"><a href="seasonal-arima.html#r-3"><i class="fa fa-check"></i><b>5.6.1</b> R</a></li>
<li class="chapter" data-level="5.6.2" data-path="seasonal-arima.html"><a href="seasonal-arima.html#python-3"><i class="fa fa-check"></i><b>5.6.2</b> Python</a></li>
<li class="chapter" data-level="5.6.3" data-path="seasonal-arima.html"><a href="seasonal-arima.html#sas-3"><i class="fa fa-check"></i><b>5.6.3</b> SAS</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="seasonal-arima.html"><a href="seasonal-arima.html#seasonal-arima-modeling"><i class="fa fa-check"></i><b>5.7</b> Seasonal ARIMA Modeling</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="seasonal-arima.html"><a href="seasonal-arima.html#r-4"><i class="fa fa-check"></i><b>5.7.1</b> R</a></li>
<li class="chapter" data-level="5.7.2" data-path="seasonal-arima.html"><a href="seasonal-arima.html#python-4"><i class="fa fa-check"></i><b>5.7.2</b> Python</a></li>
<li class="chapter" data-level="5.7.3" data-path="seasonal-arima.html"><a href="seasonal-arima.html#sas-4"><i class="fa fa-check"></i><b>5.7.3</b> SAS</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="seasonal-arima.html"><a href="seasonal-arima.html#multiplicative-vs.-additive"><i class="fa fa-check"></i><b>5.8</b> Multiplicative vs. Additive</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="dynamic-regression.html"><a href="dynamic-regression.html"><i class="fa fa-check"></i><b>6</b> Dynamic Regression</a>
<ul>
<li class="chapter" data-level="6.1" data-path="dynamic-regression.html"><a href="dynamic-regression.html#external-variables"><i class="fa fa-check"></i><b>6.1</b> External Variables</a></li>
<li class="chapter" data-level="6.2" data-path="dynamic-regression.html"><a href="dynamic-regression.html#intervention-variables"><i class="fa fa-check"></i><b>6.2</b> Intervention Variables</a></li>
<li class="chapter" data-level="6.3" data-path="dynamic-regression.html"><a href="dynamic-regression.html#point-intervention"><i class="fa fa-check"></i><b>6.3</b> Point Intervention</a></li>
<li class="chapter" data-level="6.4" data-path="dynamic-regression.html"><a href="dynamic-regression.html#step-intervention"><i class="fa fa-check"></i><b>6.4</b> Step Intervention</a></li>
<li class="chapter" data-level="6.5" data-path="dynamic-regression.html"><a href="dynamic-regression.html#ramp-intervention"><i class="fa fa-check"></i><b>6.5</b> Ramp Intervention</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="dynamic-regression.html"><a href="dynamic-regression.html#r-5"><i class="fa fa-check"></i><b>6.5.1</b> R</a></li>
<li class="chapter" data-level="6.5.2" data-path="dynamic-regression.html"><a href="dynamic-regression.html#python-5"><i class="fa fa-check"></i><b>6.5.2</b> Python</a></li>
<li class="chapter" data-level="6.5.3" data-path="dynamic-regression.html"><a href="dynamic-regression.html#sas-5"><i class="fa fa-check"></i><b>6.5.3</b> SAS</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="dynamic-regression.html"><a href="dynamic-regression.html#predictor-variables"><i class="fa fa-check"></i><b>6.6</b> Predictor Variables</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="dynamic-regression.html"><a href="dynamic-regression.html#r-6"><i class="fa fa-check"></i><b>6.6.1</b> R</a></li>
<li class="chapter" data-level="6.6.2" data-path="dynamic-regression.html"><a href="dynamic-regression.html#python-6"><i class="fa fa-check"></i><b>6.6.2</b> Python</a></li>
<li class="chapter" data-level="6.6.3" data-path="dynamic-regression.html"><a href="dynamic-regression.html#sas-6"><i class="fa fa-check"></i><b>6.6.3</b> SAS</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Time Series 1</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dynamic-regression" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Dynamic Regression<a href="dynamic-regression.html#dynamic-regression" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="external-variables" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> External Variables<a href="dynamic-regression.html#external-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Predictor variables are used for variety of things. Previously we have seen them used for accounting for trend and for seasonality. However, we can also use external variables to help make our forecasts better. Variables such as holiday effects, sales promotions, economic factors, and changes in policy are just a few examples.</p>
<p>These external / predictor variables are incorporated in a regression and the time series component is applied to the errors from this regression model:</p>
<p><span class="math display">\[
Y_t = \beta_0 + \beta_1X_1 + \cdots + \beta_kX_k + Z_t
\]</span></p>
<p>The <span class="math inline">\(Z_t\)</span> in the above equation is where the time series (typically ARIMA) model is applied. This form of modeling has many names - dynamic regression, ARIMAX, transfer functions, just to name a few.</p>
</div>
<div id="intervention-variables" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Intervention Variables<a href="dynamic-regression.html#intervention-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>An intervention variable is a variable that contains discrete values that flag the occurrence of an event affecting the response series. These variables are used to model and forecast the series itself or analyze the impact of the specific event. For example, We can measure the impact of a previous sales promotion and forecast a future sales promotion’s impact. We add these discrete variables in models to adjust the intercept of the model during the events.</p>
<p>The three most common types of intervention variables are:</p>
<ul>
<li><p>Point interventions</p></li>
<li><p>Shift interventions</p></li>
<li><p>Ramp interventions</p></li>
</ul>
</div>
<div id="point-intervention" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Point Intervention<a href="dynamic-regression.html#point-intervention" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A point intervention is typically denoted with a binary variable that flags when event occurs by taking a value of 1 with all other values set to zero. By putting this variable in our model, the coefficient on the intervention variable in the regression measures the estimated impact of that intervention.</p>
<div class="float">
<img src="InterventionPoint.png" alt="PointIntervention" />
<div class="figcaption">PointIntervention</div>
</div>
</div>
<div id="step-intervention" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Step Intervention<a href="dynamic-regression.html#step-intervention" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A step intervention is typically denoted with a binary variable that flags when an event occurs as well as the time period that the effects of the event last. For example, if you have a change in policy, you would have 0 values for dates before the policy change and values of 1 for every date after the change in policy. By putting this variable in our model, the coefficient on the intervention variable in the regression measures the estimated impact of that intervention’s shift.</p>
<div class="float">
<img src="InterventionStep.png" alt="StepIntervention" />
<div class="figcaption">StepIntervention</div>
</div>
</div>
<div id="ramp-intervention" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Ramp Intervention<a href="dynamic-regression.html#ramp-intervention" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A ramp intervention is typically denoted by 0 values before an event and values that increase by 1 (1,2,3, etc.) starting with the event time point itself. By putting this variable in our model, the coefficient on the intervention variable in the regression measures the estimated slope of this new relationship after the event.</p>
<div class="float">
<img src="InterventionRamp.png" alt="RampIntervention" />
<div class="figcaption">RampIntervention</div>
</div>
<p>Implementation</p>
<p>Let’s see how to do this in each of our softwares!</p>
<div id="r-5" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> R<a href="dynamic-regression.html#r-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our dataset we have a step intervention at September, 2001. We can easily create a binary variable that takes a value of 1 after that month and 0 before. By using the formula structure in the ARIMA function in the model function, we can add this intervention to our model as well as build out an automatic seasonal ARIMA. We use the report and gg_tsresiduals() functions to evaluate our model.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="dynamic-regression.html#cb1-1" tabindex="-1"></a>train<span class="ot">&lt;-</span>train <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Sep11 =</span> <span class="fu">if_else</span>(date <span class="sc">&gt;=</span> <span class="fu">yearmonth</span>(<span class="st">&quot;2000 Sep&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb1-2"><a href="dynamic-regression.html#cb1-2" tabindex="-1"></a>new_model<span class="ot">&lt;-</span>train <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Passengers <span class="sc">~</span> <span class="fu">fourier</span>(<span class="at">K=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">trend</span>()<span class="sc">+</span>Sep11))</span>
<span id="cb1-3"><a href="dynamic-regression.html#cb1-3" tabindex="-1"></a><span class="fu">report</span>(new_model)</span></code></pre></div>
<pre><code>## Series: Passengers 
## Model: LM w/ ARIMA(3,0,0)(1,0,0)[12] errors 
## 
## Coefficients:
##          ar1     ar2     ar3    sar1  fourier(K = 6)C1_12  fourier(K = 6)S1_12
##       0.6409  0.1090  0.0866  0.3491            -4398.041            1131.4722
## s.e.  0.0714  0.0829  0.0695  0.0744              407.575             406.8423
##       fourier(K = 6)C2_12  fourier(K = 6)S2_12  fourier(K = 6)C3_12
##                  623.1931            -439.0598           -2578.0661
## s.e.             247.1645             247.2930             208.2801
##       fourier(K = 6)S3_12  fourier(K = 6)C4_12  fourier(K = 6)S4_12
##                -1306.9302             252.5545            -374.3603
## s.e.             208.8032             188.8733             188.8001
##       fourier(K = 6)C5_12  fourier(K = 6)S5_12  fourier(K = 6)C6_12  trend()
##                  947.0734           -2140.5655            -340.8753  99.9567
## s.e.             168.4445             169.0065             112.9862  20.8172
##          Sep11  intercept
##       3698.924  38175.713
## s.e.  2071.972   2077.692
## 
## sigma^2 estimated as 3391371:  log likelihood=-1841.98
## AIC=3721.96   AICc=3726.03   BIC=3785.29</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="dynamic-regression.html#cb3-1" tabindex="-1"></a>future_val <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb3-2"><a href="dynamic-regression.html#cb3-2" tabindex="-1"></a>     <span class="at">date =</span> <span class="fu">yearmonth</span>(<span class="st">&quot;2007 Apr&quot;</span>) <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>,    <span class="co"># forecast 6 months ahead</span></span>
<span id="cb3-3"><a href="dynamic-regression.html#cb3-3" tabindex="-1"></a>     <span class="at">Sep11 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">12</span>)                <span class="co"># assumed future ad spend</span></span>
<span id="cb3-4"><a href="dynamic-regression.html#cb3-4" tabindex="-1"></a> ) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="dynamic-regression.html#cb3-5" tabindex="-1"></a>     <span class="fu">as_tsibble</span>(<span class="at">index =</span> date)</span>
<span id="cb3-6"><a href="dynamic-regression.html#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="dynamic-regression.html#cb3-7" tabindex="-1"></a>for_newmodel<span class="ot">&lt;-</span>fabletools<span class="sc">::</span><span class="fu">forecast</span>(new_model, <span class="at">new_data =</span> future_val)</span>
<span id="cb3-8"><a href="dynamic-regression.html#cb3-8" tabindex="-1"></a>for_newmodel <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>(USAirlines_ts)<span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>.fitted),<span class="at">col=</span><span class="st">&quot;#D55E00&quot;</span>,<span class="at">data=</span><span class="fu">augment</span>(new_model))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="dynamic-regression.html#cb4-1" tabindex="-1"></a><span class="fu">report</span>(new_model)</span></code></pre></div>
<pre><code>## Series: Passengers 
## Model: LM w/ ARIMA(3,0,0)(1,0,0)[12] errors 
## 
## Coefficients:
##          ar1     ar2     ar3    sar1  fourier(K = 6)C1_12  fourier(K = 6)S1_12
##       0.6409  0.1090  0.0866  0.3491            -4398.041            1131.4722
## s.e.  0.0714  0.0829  0.0695  0.0744              407.575             406.8423
##       fourier(K = 6)C2_12  fourier(K = 6)S2_12  fourier(K = 6)C3_12
##                  623.1931            -439.0598           -2578.0661
## s.e.             247.1645             247.2930             208.2801
##       fourier(K = 6)S3_12  fourier(K = 6)C4_12  fourier(K = 6)S4_12
##                -1306.9302             252.5545            -374.3603
## s.e.             208.8032             188.8733             188.8001
##       fourier(K = 6)C5_12  fourier(K = 6)S5_12  fourier(K = 6)C6_12  trend()
##                  947.0734           -2140.5655            -340.8753  99.9567
## s.e.             168.4445             169.0065             112.9862  20.8172
##          Sep11  intercept
##       3698.924  38175.713
## s.e.  2071.972   2077.692
## 
## sigma^2 estimated as 3391371:  log likelihood=-1841.98
## AIC=3721.96   AICc=3726.03   BIC=3785.29</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="dynamic-regression.html#cb6-1" tabindex="-1"></a>new_model <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="dynamic-regression.html#cb6-2" tabindex="-1"></a>  <span class="fu">gg_tsresiduals</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-3-2.png" width="672" /></p>
<p>We can also check if the model produces white noise residuals using the augment and features functions with the ljung_box option.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="dynamic-regression.html#cb7-1" tabindex="-1"></a><span class="fu">augment</span>(new_model) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="dynamic-regression.html#cb7-2" tabindex="-1"></a>  <span class="fu">features</span>(.innov, ljung_box, <span class="at">lag =</span> <span class="dv">36</span>, <span class="at">dof =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .model                                               lb_stat lb_pvalue
##   &lt;chr&gt;                                                  &lt;dbl&gt;     &lt;dbl&gt;
## 1 ARIMA(Passengers ~ fourier(K = 6) + trend() + Sep11)    25.2     0.831</code></pre>
<p>We can see from the output above that our model now accounts for the outlier that we previously saw in our data. Notice how our model has changed slightly after accounting for this outlier. This will improve the forecasts going forward, even though we do not have any outliers in our test dataset.</p>
<p>To forecast these values going forward, we need future values of our predictor variable. For this dataset, we have our Sep11 variable that we forecast to have values of 0 for each of the 12 observations we are forecasting for airline passengers. To do this we create another variable (of the same name) that has future values in our test dataset. We then use the forecast function with both the model and the test dataset as inputs. The forecast function will be expecting a test dataset that contains the Sep11 variable in it.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="dynamic-regression.html#cb9-1" tabindex="-1"></a>test<span class="sc">$</span>Sep11 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">12</span>)</span>
<span id="cb9-2"><a href="dynamic-regression.html#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="dynamic-regression.html#cb9-3" tabindex="-1"></a>model_ARIMAX_for <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">forecast</span>(new_model, test)</span></code></pre></div>
</div>
<div id="python-5" class="section level3 hasAnchor" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Python<a href="dynamic-regression.html#python-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our dataset we have a point intervention at September, 2001. We can easily create a binary variable that takes a value of 1 during that month and 0 otherwise. By using the merge function on our training dataset we can add this new variable to our training data. Now, in the AutoARIMA function, we can add this intervention to our model as well as build out a seasonal ARIMA by just putting the training dataset with this new column in the .fit function. This means we have to be careful about which datasets we use since Python automatically assumes any additional column (beyond unique_id, ds, and y) are predictor variables. We use the .fitted_[0][0].model_.get() and function to evaluate our model by asking for the order of the ARIMA model (arma), the coefficients in the ARIMA model (coef) and the AIC (aic).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="dynamic-regression.html#cb10-1" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> AutoARIMA, ARIMA</span>
<span id="cb10-2"><a href="dynamic-regression.html#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="dynamic-regression.html#cb10-3" tabindex="-1"></a>Sep11 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">207</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb10-4"><a href="dynamic-regression.html#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="dynamic-regression.html#cb10-5" tabindex="-1"></a>d_X <span class="op">=</span> {<span class="st">&#39;unique_id&#39;</span>: <span class="dv">1</span>, <span class="st">&#39;ds&#39;</span>: train.index, <span class="st">&#39;Sep11&#39;</span>: Sep11}</span>
<span id="cb10-6"><a href="dynamic-regression.html#cb10-6" tabindex="-1"></a>X_sf <span class="op">=</span> pd.DataFrame(data <span class="op">=</span> d_X)</span>
<span id="cb10-7"><a href="dynamic-regression.html#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="dynamic-regression.html#cb10-8" tabindex="-1"></a>X_sf.loc[<span class="dv">140</span>, <span class="st">&#39;Sep11&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb10-9"><a href="dynamic-regression.html#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="dynamic-regression.html#cb10-10" tabindex="-1"></a>train_sf_X <span class="op">=</span> train_sf.merge(X_sf, how <span class="op">=</span> <span class="st">&#39;left&#39;</span>, on <span class="op">=</span> [<span class="st">&#39;unique_id&#39;</span>, <span class="st">&#39;ds&#39;</span>]) </span>
<span id="cb10-11"><a href="dynamic-regression.html#cb10-11" tabindex="-1"></a></span>
<span id="cb10-12"><a href="dynamic-regression.html#cb10-12" tabindex="-1"></a>model_ARIMAX <span class="op">=</span> StatsForecast(models <span class="op">=</span> [AutoARIMA(season_length <span class="op">=</span> <span class="dv">12</span>, allowdrift <span class="op">=</span> <span class="va">True</span>)], freq <span class="op">=</span> <span class="st">&#39;ME&#39;</span>)</span>
<span id="cb10-13"><a href="dynamic-regression.html#cb10-13" tabindex="-1"></a>model_ARIMAX.fit(df <span class="op">=</span> train_sf_X)</span></code></pre></div>
<pre><code>## StatsForecast(models=[AutoARIMA])</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="dynamic-regression.html#cb12-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;arma&quot;</span>)</span></code></pre></div>
<pre><code>## (2, 1, 1, 2, 12, 0, 1)</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="dynamic-regression.html#cb14-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;coef&quot;</span>)</span></code></pre></div>
<pre><code>## {&#39;ar1&#39;: 0.13134602931994888, &#39;ar2&#39;: 0.5552223660064508, &#39;ma1&#39;: 0.48357739638505537, &#39;sar1&#39;: -0.5813428814692551, &#39;sma1&#39;: -0.018930442731758503, &#39;sma2&#39;: -0.390927638995888, &#39;ex_1&#39;: -14131.99804734699}</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="dynamic-regression.html#cb16-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;aic&quot;</span>)</span></code></pre></div>
<pre><code>## 3491.097241911011</code></pre>
<p>We can also check if the model produces white noise residuals using the acorr_ljungbox from the statsmodels package on the residuals from our model.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="dynamic-regression.html#cb18-1" tabindex="-1"></a>sm.stats.acorr_ljungbox(model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;residuals&quot;</span>), lags <span class="op">=</span> [<span class="dv">12</span>], model_df <span class="op">=</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>##       lb_stat  lb_pvalue
## 12  18.351359   0.010481</code></pre>
<p>We can see from the output above that our model now accounts for the outlier that we previously saw in our data. Notice how our model has changed slightly after accounting for this outlier. This will improve the forecasts going forward, even though we do not have any outliers in our validation dataset.</p>
<p>To forecast these values going forward, we need future values of our predictor variable. For this dataset, we have our Sep11 variable that we forecast to have values of 0 for each of the 12 observations we are forecasting for airline passengers. To do this we create another variable (of the same name) that has future values. This new variable is then put into the test dataset which gets passed inside of the .forecast function. The function is expecting a variable in the test dataset called Sep11 in it.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="dynamic-regression.html#cb20-1" tabindex="-1"></a></span>
<span id="cb20-2"><a href="dynamic-regression.html#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="dynamic-regression.html#cb20-3" tabindex="-1"></a>Sep11 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">12</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb20-4"><a href="dynamic-regression.html#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="dynamic-regression.html#cb20-5" tabindex="-1"></a>d_X <span class="op">=</span> {<span class="st">&#39;unique_id&#39;</span>: <span class="dv">1</span>, <span class="st">&#39;ds&#39;</span>: test.index, <span class="st">&#39;Sep11&#39;</span>: Sep11}</span>
<span id="cb20-6"><a href="dynamic-regression.html#cb20-6" tabindex="-1"></a>X_sf <span class="op">=</span> pd.DataFrame(data <span class="op">=</span> d_X)</span>
<span id="cb20-7"><a href="dynamic-regression.html#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="dynamic-regression.html#cb20-8" tabindex="-1"></a>test_sf_X <span class="op">=</span> test_sf.merge(X_sf, how <span class="op">=</span> <span class="st">&#39;left&#39;</span>, on <span class="op">=</span> [<span class="st">&#39;unique_id&#39;</span>, <span class="st">&#39;ds&#39;</span>]) </span>
<span id="cb20-9"><a href="dynamic-regression.html#cb20-9" tabindex="-1"></a></span>
<span id="cb20-10"><a href="dynamic-regression.html#cb20-10" tabindex="-1"></a>model_ARIMAX_for <span class="op">=</span> model_ARIMAX.forecast(df <span class="op">=</span> train_sf_X, h <span class="op">=</span> <span class="dv">12</span>, X_df <span class="op">=</span> X_sf, level <span class="op">=</span> [<span class="dv">95</span>])</span></code></pre></div>
<p>We can plot our forecasts just as we have done previously.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="dynamic-regression.html#cb21-1" tabindex="-1"></a>model_ARIMAX.plot(train_sf, model_ARIMAX_for).savefig(<span class="st">&#39;plot_for_ARIMAX.png&#39;</span>)</span></code></pre></div>
<pre><code>## C:\PROGRA~3\ANACON~1\Lib\site-packages\statsforecast\core.py:1447: FutureWarning: Passing the ids as the index is deprecated. Please provide them as a column instead.
##   warnings.warn(</code></pre>
</div>
<div id="sas-5" class="section level3 hasAnchor" number="6.5.3">
<h3><span class="header-section-number">6.5.3</span> SAS<a href="dynamic-regression.html#sas-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our dataset we have a point intervention at September, 2001. We can easily create a binary variable that takes a value of 1 during that month and 0 otherwise. We also need to create a dataset that blanks out all the values of the Passenger variable past in our test window. SAS needs a dataset with the training data as well as future values of the predictor variables to forecast with dynamic regression.</p>
<p>From there we use the PROC ARIMA procedure with this newly created dataset. With the IDENTIFY statement we give our target variable with the VAR option. Remember, the (12) after the target variable signals that we want to take the seasonal difference. We also include the CROSSCORR option with our predictor variable Sep11. We include the MINIC option as well to help with order selection of the ARIMA model. We then use the ESTIMATE statement to define our model, here an ARIMA(1,0,0)(1,1,1) model. The INPUT option is where we put our Sep11 variable into the actual model. We finish with the FORECAST statement with the LEAD option set to 12 to forecast the next 12 observations.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="dynamic-regression.html#cb23-1" tabindex="-1"></a>data usair_pred;</span>
<span id="cb23-2"><a href="dynamic-regression.html#cb23-2" tabindex="-1"></a>    set usair;</span>
<span id="cb23-3"><a href="dynamic-regression.html#cb23-3" tabindex="-1"></a>    Sep11 <span class="ot">=</span> <span class="dv">0</span>;</span>
<span id="cb23-4"><a href="dynamic-regression.html#cb23-4" tabindex="-1"></a>    <span class="cf">if</span> date <span class="ot">=</span> <span class="st">&#39;1sep2001&#39;</span>d then Sep11 <span class="ot">=</span> <span class="dv">1</span>;</span>
<span id="cb23-5"><a href="dynamic-regression.html#cb23-5" tabindex="-1"></a>    <span class="cf">if</span> date <span class="sc">&gt;</span> <span class="st">&#39;1mar2007&#39;</span>d then Passengers <span class="ot">=</span> .;</span>
<span id="cb23-6"><a href="dynamic-regression.html#cb23-6" tabindex="-1"></a>run;</span>
<span id="cb23-7"><a href="dynamic-regression.html#cb23-7" tabindex="-1"></a>    </span>
<span id="cb23-8"><a href="dynamic-regression.html#cb23-8" tabindex="-1"></a>proc arima data <span class="ot">=</span> work.usair_pred plots <span class="ot">=</span> all;</span>
<span id="cb23-9"><a href="dynamic-regression.html#cb23-9" tabindex="-1"></a>    identify var <span class="ot">=</span> <span class="fu">Passengers</span>(<span class="dv">12</span>) nlag <span class="ot">=</span> <span class="dv">24</span> crosscorr <span class="ot">=</span> (Sep11) minic P<span class="ot">=</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">15</span>) Q<span class="ot">=</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">15</span>);</span>
<span id="cb23-10"><a href="dynamic-regression.html#cb23-10" tabindex="-1"></a>    estimate p <span class="ot">=</span> (<span class="dv">1</span>)(<span class="dv">12</span>) q <span class="ot">=</span> (<span class="dv">12</span>) input <span class="ot">=</span> (Sep11);</span>
<span id="cb23-11"><a href="dynamic-regression.html#cb23-11" tabindex="-1"></a>    forecast lead <span class="ot">=</span> <span class="dv">12</span> id <span class="ot">=</span> date interval <span class="ot">=</span> month;</span>
<span id="cb23-12"><a href="dynamic-regression.html#cb23-12" tabindex="-1"></a>run;</span></code></pre></div>
<div class="float">
<img src="10_a_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<div class="float">
<img src="10_b_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<div class="float">
<img src="10_c_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<p>We can check if the model produces white noise residuals by looking at the results above with the autocorrelations of the residuals and the corresponding p-values. We can also look at the white noise plot. Both of these seem to show white noise residuals.</p>
<p>We can see from the output above that our model now accounts for the outlier that we previously saw in our data. Notice how our model has changed slightly after accounting for this outlier. This will improve the forecasts going forward, even though we do not have any outliers in our test dataset.</p>
<p>Let’s look at our forecast plot from our output like we have done previously.</p>
<div class="float">
<img src="10_d_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
</div>
</div>
<div id="predictor-variables" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Predictor Variables<a href="dynamic-regression.html#predictor-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Most forecasting models also need to account for explanatory variables such as price, advertising spending, or income. These kinds of models can be called any of the following: dynamic regression, ARIMAX, transfer functions. Through the examples above, we have seen how to implement this in R.</p>
<p>However, there are often lagged variables (lags of the predictor variables) as well as (or instead of) immediate impacts of these variables. In other words, previous values of the predictor variables may still play a role in the current prediction of the target variable. The question becomes, how many lags of a variable need to be included in the model. There are multiple ways to evaluate how many lags of a predictor variable you need in a model.</p>
<p>The first, more theoretical approach, involves cross correlations and pre-whitening of series. This approach is time consuming, requires building a model for the predictor variables themselves, and is therefore best used for small numbers of predictor variables.</p>
<p>The second approach evaluates many difference combinations of lags of the predictor variable in many different models. These models are compared on a metric like AIC/BIC on a validation dataset to see which models the data best. This approach is more efficient, handles many variables much easier, and is similar in accuracy to the first approach.</p>
<p>Let’s see how to do this in each of our softwares!</p>
<div id="r-6" class="section level3 hasAnchor" number="6.6.1">
<h3><span class="header-section-number">6.6.1</span> R<a href="dynamic-regression.html#r-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will take the same approach as above to building a dynamic regression in R. We will still use the formula approach to put in our model in the ARIMA function of the model function on our training data. R has a built in lag function that we can apply to predictor variables to lag them. We will put in the original Sep11 variable and lag variables for lags 1, 2, 3, and 12. Essentially, we believe that the effects of the attacks on September 11 were felt for 3 months as well as on the one year anniversary 12 months later. From there we will build two ARIMA models. The first is a specific model using the model we developed by hand in the previous section on seasonal ARIMA models. This is the ARIMA (1,0,0)(1,1,1) model. We input this model using the pdq and PDQ functions for regular and seasonal orders respectively. Next, we will leave out the pdq and PDQ functions so R will automatically search for the “best” ARIMA model. Lastly, we use the glance function to take a look at the performance of these models on training data.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="dynamic-regression.html#cb24-1" tabindex="-1"></a>model_ARIMAX <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="dynamic-regression.html#cb24-2" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb24-3"><a href="dynamic-regression.html#cb24-3" tabindex="-1"></a>    <span class="at">hand =</span> <span class="fu">ARIMA</span>(Passengers <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Sep11 <span class="sc">+</span> <span class="fu">lag</span>(Sep11) <span class="sc">+</span> <span class="fu">lag</span>(Sep11, <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb24-4"><a href="dynamic-regression.html#cb24-4" tabindex="-1"></a>                <span class="fu">lag</span>(Sep11, <span class="dv">3</span>) <span class="sc">+</span> <span class="fu">lag</span>(Sep11, <span class="dv">12</span>) <span class="sc">+</span> <span class="fu">pdq</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>) <span class="sc">+</span> <span class="fu">PDQ</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)),</span>
<span id="cb24-5"><a href="dynamic-regression.html#cb24-5" tabindex="-1"></a>    <span class="at">auto =</span> <span class="fu">ARIMA</span>(Passengers <span class="sc">~</span> Sep11 <span class="sc">+</span> <span class="fu">lag</span>(Sep11) <span class="sc">+</span> <span class="fu">lag</span>(Sep11, <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb24-6"><a href="dynamic-regression.html#cb24-6" tabindex="-1"></a>                <span class="fu">lag</span>(Sep11, <span class="dv">3</span>) <span class="sc">+</span> <span class="fu">lag</span>(Sep11, <span class="dv">12</span>))</span>
<span id="cb24-7"><a href="dynamic-regression.html#cb24-7" tabindex="-1"></a>    )</span>
<span id="cb24-8"><a href="dynamic-regression.html#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="dynamic-regression.html#cb24-9" tabindex="-1"></a><span class="fu">glance</span>(model_ARIMAX)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 8
##   .model   sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  
##   &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;     &lt;list&gt;    
## 1 hand   1967134.  -1590. 3199. 3201. 3232. &lt;cpl [13]&gt; &lt;cpl [12]&gt;
## 2 auto   1937233.  -1579. 3177. 3178. 3210. &lt;cpl [26]&gt; &lt;cpl [0]&gt;</code></pre>
<p>Based on the likelihood-based metrics above like AIC and BIC, the automatically selected ARIMA model beats out the by hand model, but all the metrics are rather close. Let’s also evaluate the residuals from these models using the gg_tsresiduals() function as well as the features function with the ljung_box option for white noise testing. Since we have multiple models in the model function above, we will need to isolate the models with the select function and filter function respectively for the analysis below.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="dynamic-regression.html#cb26-1" tabindex="-1"></a>model_ARIMAX <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="dynamic-regression.html#cb26-2" tabindex="-1"></a>  <span class="fu">select</span>(hand) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="dynamic-regression.html#cb26-3" tabindex="-1"></a>  <span class="fu">gg_tsresiduals</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="dynamic-regression.html#cb27-1" tabindex="-1"></a><span class="fu">augment</span>(model_ARIMAX) <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="dynamic-regression.html#cb27-2" tabindex="-1"></a>  <span class="fu">filter</span>(.model <span class="sc">==</span> <span class="st">&quot;hand&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="dynamic-regression.html#cb27-3" tabindex="-1"></a>  <span class="fu">features</span>(.innov, ljung_box, <span class="at">lag =</span> <span class="dv">36</span>, <span class="at">dof =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .model lb_stat lb_pvalue
##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 hand      57.1   0.00294</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="dynamic-regression.html#cb29-1" tabindex="-1"></a>model_ARIMAX <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="dynamic-regression.html#cb29-2" tabindex="-1"></a>  <span class="fu">select</span>(auto) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="dynamic-regression.html#cb29-3" tabindex="-1"></a>  <span class="fu">gg_tsresiduals</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-12-2.png" width="672" /></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="dynamic-regression.html#cb30-1" tabindex="-1"></a><span class="fu">augment</span>(model_ARIMAX) <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="dynamic-regression.html#cb30-2" tabindex="-1"></a>  <span class="fu">filter</span>(.model <span class="sc">==</span> <span class="st">&quot;auto&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="dynamic-regression.html#cb30-3" tabindex="-1"></a>  <span class="fu">features</span>(.innov, ljung_box, <span class="at">lag =</span> <span class="dv">36</span>, <span class="at">dof =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .model lb_stat lb_pvalue
##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 auto      50.5    0.0150</code></pre>
<p>The by hand model has a higher p-value for the Ljung-Box white noise test, but both models result, statistically, in white noise residuals.</p>
<p>Let’s forecast both of these models to compare the results with the test dataset. To forecast these values going forward, we need future values of our predictor variable. For this dataset, we have our Sep11 variable that we forecast to have values of 0 for each of the 12 observations we are forecasting for airline passengers. To do this we create another variable (of the same name) that has future values in our test dataset. We then use the forecast function with both the model and the test dataset as inputs. The forecast function will be expecting a test dataset that contains the Sep11 variable in it. We also plot the two forecasts together on the same plot.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="dynamic-regression.html#cb32-1" tabindex="-1"></a>test<span class="sc">$</span>Sep11 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">12</span>)</span>
<span id="cb32-2"><a href="dynamic-regression.html#cb32-2" tabindex="-1"></a></span>
<span id="cb32-3"><a href="dynamic-regression.html#cb32-3" tabindex="-1"></a>model_ARIMAX_for <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">forecast</span>(model_ARIMAX, test)</span>
<span id="cb32-4"><a href="dynamic-regression.html#cb32-4" tabindex="-1"></a></span>
<span id="cb32-5"><a href="dynamic-regression.html#cb32-5" tabindex="-1"></a>model_ARIMAX_for <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="dynamic-regression.html#cb32-6" tabindex="-1"></a>  <span class="fu">autoplot</span>(train) <span class="sc">+</span> </span>
<span id="cb32-7"><a href="dynamic-regression.html#cb32-7" tabindex="-1"></a>  <span class="fu">autolayer</span>(<span class="fu">fitted</span>(model_ARIMAX), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb32-8"><a href="dynamic-regression.html#cb32-8" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Airlines Passengers&quot;</span>) <span class="sc">+</span> </span>
<span id="cb32-9"><a href="dynamic-regression.html#cb32-9" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="st">&quot;2007-03-15&quot;</span>), <span class="at">color=</span><span class="st">&quot;orange&quot;</span>, <span class="at">linetype=</span><span class="st">&quot;longdash&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>We can use the accuracy function from the fabletools package to evaluate these forecasts. The only inputs for this function are the model object and the test dataset.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="dynamic-regression.html#cb33-1" tabindex="-1"></a>fabletools<span class="sc">::</span><span class="fu">accuracy</span>(model_ARIMAX_for, test)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 10
##   .model .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1
##   &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 auto   Test  -2110. 3019. 2642. -3.39  4.19   NaN   NaN 0.414
## 2 hand   Test  -2088. 3114. 2653. -3.39  4.24   NaN   NaN 0.602</code></pre>
<p>Although the automatically selected ARIMA model barely beat the hand selected model in the training dataset metrics, it appears as if the ARIMA models selected by hand has both a better mean absolute error (MAE) and mean absolute percentage error (MAPE) on the test dataset.</p>
</div>
<div id="python-6" class="section level3 hasAnchor" number="6.6.2">
<h3><span class="header-section-number">6.6.2</span> Python<a href="dynamic-regression.html#python-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will take the same approach as above to building a dynamic regression in Python. For our dataset we have a point intervention at September, 2001. We can easily create a binary variable that takes a value of 1 during that month and 0 otherwise. However, we also have to create some lag variables to be added to the model as well. We will put in the original Sep11 variable and lag variables for lags 1, 2, 3, and 12. Essentially, we believe that the effects of the attacks on September 11 were felt for 3 months as well as on the one year anniversary 12 months later. By using the merge function on our training dataset we can add these new variables to our training data.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="dynamic-regression.html#cb35-1" tabindex="-1"></a>Sep11 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">207</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb35-2"><a href="dynamic-regression.html#cb35-2" tabindex="-1"></a>Sep11_L1 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">207</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb35-3"><a href="dynamic-regression.html#cb35-3" tabindex="-1"></a>Sep11_L2 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">207</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb35-4"><a href="dynamic-regression.html#cb35-4" tabindex="-1"></a>Sep11_L3 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">207</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb35-5"><a href="dynamic-regression.html#cb35-5" tabindex="-1"></a>Sep11_L12 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">207</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb35-6"><a href="dynamic-regression.html#cb35-6" tabindex="-1"></a></span>
<span id="cb35-7"><a href="dynamic-regression.html#cb35-7" tabindex="-1"></a>d_X <span class="op">=</span> {<span class="st">&#39;unique_id&#39;</span>: <span class="dv">1</span>, <span class="st">&#39;ds&#39;</span>: train.index, <span class="st">&#39;Sep11&#39;</span>: Sep11, <span class="st">&#39;Sep11_L1&#39;</span>: Sep11_L1, <span class="st">&#39;Sep11_L2&#39;</span>: Sep11_L2, <span class="st">&#39;Sep11_L3&#39;</span>: Sep11_L3, <span class="st">&#39;Sep11_L12&#39;</span>: Sep11_L12}</span>
<span id="cb35-8"><a href="dynamic-regression.html#cb35-8" tabindex="-1"></a>X_sf <span class="op">=</span> pd.DataFrame(data <span class="op">=</span> d_X)</span>
<span id="cb35-9"><a href="dynamic-regression.html#cb35-9" tabindex="-1"></a></span>
<span id="cb35-10"><a href="dynamic-regression.html#cb35-10" tabindex="-1"></a>X_sf.loc[<span class="dv">140</span>, <span class="st">&#39;Sep11&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-11"><a href="dynamic-regression.html#cb35-11" tabindex="-1"></a>X_sf.loc[<span class="dv">141</span>, <span class="st">&#39;Sep11_L1&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-12"><a href="dynamic-regression.html#cb35-12" tabindex="-1"></a>X_sf.loc[<span class="dv">142</span>, <span class="st">&#39;Sep11_L2&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-13"><a href="dynamic-regression.html#cb35-13" tabindex="-1"></a>X_sf.loc[<span class="dv">143</span>, <span class="st">&#39;Sep11_L3&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-14"><a href="dynamic-regression.html#cb35-14" tabindex="-1"></a>X_sf.loc[<span class="dv">152</span>, <span class="st">&#39;Sep11_L12&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-15"><a href="dynamic-regression.html#cb35-15" tabindex="-1"></a></span>
<span id="cb35-16"><a href="dynamic-regression.html#cb35-16" tabindex="-1"></a>train_sf_X <span class="op">=</span> train_sf.merge(X_sf, how <span class="op">=</span> <span class="st">&#39;left&#39;</span>, on <span class="op">=</span> [<span class="st">&#39;unique_id&#39;</span>, <span class="st">&#39;ds&#39;</span>]) </span></code></pre></div>
<p>From there we will build two ARIMA models. The first is a specific model using the model we developed by hand in the previous section on seasonal ARIMA models. This is the ARIMA (1,0,0)(1,1,1) model. We input this model using the order and seasonal_order functions for regular and seasonal orders respectively. Next, in the AutoARIMA function we will let Python automatically select the best ARIMA model. ,We can add the intervention variables to our model by just putting the training dataset with these new columns in the .fit function. This means we have to be careful about which datasets we use since Python automatically assumes any additional column (beyond unique_id, ds, and y) are predictor variables. We use the .fitted_[0][0].model_.get() and function to evaluate our automatically selected ARIMA model by asking for the order of the ARIMA model (arma), the coefficients in the ARIMA model (coef) and the AIC (aic). If we change the function to .fitted_[0][1].model_.get() then we can get the second model we built in the StatsForecast function, the ARIMA we selected by hand.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="dynamic-regression.html#cb36-1" tabindex="-1"></a>model_ARIMAX <span class="op">=</span> StatsForecast(models <span class="op">=</span> [AutoARIMA(season_length <span class="op">=</span> <span class="dv">12</span>, allowdrift <span class="op">=</span> <span class="va">True</span>), ARIMA(order <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), season_length <span class="op">=</span> <span class="dv">12</span>, seasonal_order <span class="op">=</span> (<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), include_drift <span class="op">=</span> <span class="va">True</span>)], freq <span class="op">=</span> <span class="st">&#39;ME&#39;</span>)</span>
<span id="cb36-2"><a href="dynamic-regression.html#cb36-2" tabindex="-1"></a>model_ARIMAX.fit(df <span class="op">=</span> train_sf_X)</span></code></pre></div>
<pre><code>## StatsForecast(models=[AutoARIMA,ARIMA])</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="dynamic-regression.html#cb38-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;arma&quot;</span>)</span></code></pre></div>
<pre><code>## (1, 0, 0, 2, 12, 0, 1)</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="dynamic-regression.html#cb40-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;coef&quot;</span>)</span></code></pre></div>
<pre><code>## {&#39;ar1&#39;: 0.7375177578972858, &#39;sma1&#39;: -0.5870603509062613, &#39;sma2&#39;: -0.039390189139568606, &#39;ex_1&#39;: -16737.0, &#39;ex_2&#39;: -10928.4990234375, &#39;ex_3&#39;: -7799.9990234375, &#39;ex_4&#39;: -8401.4990234375, &#39;ex_5&#39;: -5209.9990234375}</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="dynamic-regression.html#cb42-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;aic&quot;</span>)</span></code></pre></div>
<pre><code>## 3481.4703680965195</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="dynamic-regression.html#cb44-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">1</span>].model_.get(<span class="st">&quot;arma&quot;</span>)</span></code></pre></div>
<pre><code>## (1, 0, 1, 1, 12, 0, 1)</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="dynamic-regression.html#cb46-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">1</span>].model_.get(<span class="st">&quot;coef&quot;</span>)</span></code></pre></div>
<pre><code>## {&#39;ar1&#39;: 0.6651175398360181, &#39;sar1&#39;: -0.0486860850742297, &#39;sma1&#39;: -0.5537376546510462, &#39;drift&#39;: 123.6717948717949, &#39;ex_1&#39;: -16737.000000000113, &#39;ex_2&#39;: -10928.499999999995, &#39;ex_3&#39;: -7799.999999999993, &#39;ex_4&#39;: -8401.5, &#39;ex_5&#39;: -5210.000000000056}</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="dynamic-regression.html#cb48-1" tabindex="-1"></a>model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">1</span>].model_.get(<span class="st">&quot;aic&quot;</span>)</span></code></pre></div>
<pre><code>## 3419.635116900134</code></pre>
<p>Based on the likelihood-based metrics above like AIC, the automatically selected ARIMA model beats out the by hand model, but all the metrics are rather close. Let’s also evaluate the residuals from these models using the acorr_ljungbox from the statsmodels package on the residuals from our model.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="dynamic-regression.html#cb50-1" tabindex="-1"></a>sm.stats.acorr_ljungbox(model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">0</span>].model_.get(<span class="st">&quot;residuals&quot;</span>), lags <span class="op">=</span> [<span class="dv">12</span>], model_df <span class="op">=</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>##       lb_stat  lb_pvalue
## 12  37.068832   0.000005</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="dynamic-regression.html#cb52-1" tabindex="-1"></a>sm.stats.acorr_ljungbox(model_ARIMAX.fitted_[<span class="dv">0</span>][<span class="dv">1</span>].model_.get(<span class="st">&quot;residuals&quot;</span>), lags <span class="op">=</span> [<span class="dv">12</span>], model_df <span class="op">=</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>##       lb_stat     lb_pvalue
## 12  47.669309  4.131861e-08</code></pre>
<p>The by hand model has a higher p-value for the Ljung-Box white noise test, but both models result, statistically, in not being white noise residuals.</p>
<p>Let’s forecast both of these models to compare the results with the test dataset. To forecast these values going forward, we need future values of our predictor variables. For this dataset, we have our Sep11 variable and all the lags of it we created that we forecast to have values of 0 for each of the 12 observations we are forecasting for airline passengers. To do this we create other variables (of the same name) that have future values in our test dataset. We then use the forecast function with both the model and the test dataset as inputs. We also plot the two forecasts together on the same plot.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="dynamic-regression.html#cb54-1" tabindex="-1"></a>Sep11 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">12</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb54-2"><a href="dynamic-regression.html#cb54-2" tabindex="-1"></a>Sep11_L1 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">12</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb54-3"><a href="dynamic-regression.html#cb54-3" tabindex="-1"></a>Sep11_L2 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">12</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb54-4"><a href="dynamic-regression.html#cb54-4" tabindex="-1"></a>Sep11_L3 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">12</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb54-5"><a href="dynamic-regression.html#cb54-5" tabindex="-1"></a>Sep11_L12 <span class="op">=</span> np.full(shape <span class="op">=</span> <span class="dv">12</span>, fill_value <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb54-6"><a href="dynamic-regression.html#cb54-6" tabindex="-1"></a></span>
<span id="cb54-7"><a href="dynamic-regression.html#cb54-7" tabindex="-1"></a>d_X <span class="op">=</span> {<span class="st">&#39;unique_id&#39;</span>: <span class="dv">1</span>, <span class="st">&#39;ds&#39;</span>: test.index, <span class="st">&#39;Sep11&#39;</span>: Sep11, <span class="st">&#39;Sep11_L1&#39;</span>: Sep11_L1, <span class="st">&#39;Sep11_L2&#39;</span>: Sep11_L2, <span class="st">&#39;Sep11_L3&#39;</span>: Sep11_L3, <span class="st">&#39;Sep11_L12&#39;</span>: Sep11_L12}</span>
<span id="cb54-8"><a href="dynamic-regression.html#cb54-8" tabindex="-1"></a>X_sf <span class="op">=</span> pd.DataFrame(data <span class="op">=</span> d_X)</span>
<span id="cb54-9"><a href="dynamic-regression.html#cb54-9" tabindex="-1"></a></span>
<span id="cb54-10"><a href="dynamic-regression.html#cb54-10" tabindex="-1"></a>test_sf_X <span class="op">=</span> test_sf.merge(X_sf, how <span class="op">=</span> <span class="st">&#39;left&#39;</span>, on <span class="op">=</span> [<span class="st">&#39;unique_id&#39;</span>, <span class="st">&#39;ds&#39;</span>]) </span>
<span id="cb54-11"><a href="dynamic-regression.html#cb54-11" tabindex="-1"></a></span>
<span id="cb54-12"><a href="dynamic-regression.html#cb54-12" tabindex="-1"></a>model_ARIMAX_for <span class="op">=</span> model_ARIMAX.forecast(df <span class="op">=</span> train_sf_X, h <span class="op">=</span> <span class="dv">12</span>, X_df <span class="op">=</span> X_sf, level <span class="op">=</span> [<span class="dv">95</span>])</span></code></pre></div>
<pre><code>## C:\PROGRA~3\ANACON~1\Lib\site-packages\statsforecast\core.py:492: FutureWarning: In a future version the predictions will have the id as a column. You can set the `NIXTLA_ID_AS_COL` environment variable to adopt the new behavior and to suppress this warning.
##   warnings.warn(</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="dynamic-regression.html#cb56-1" tabindex="-1"></a></span>
<span id="cb56-2"><a href="dynamic-regression.html#cb56-2" tabindex="-1"></a>model_ARIMAX.plot(train_sf, model_ARIMAX_for)</span></code></pre></div>
<div class="float">
<img src="plot_for_ARIMAX2.png" alt="Plot" />
<div class="figcaption">Plot</div>
</div>
<p>We can use the forecasted values from the above code to evaluate these forecasts by comparing them to the test dataset.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="dynamic-regression.html#cb57-1" tabindex="-1"></a>error <span class="op">=</span> np.array(test[<span class="st">&#39;Passengers&#39;</span>]) <span class="op">-</span> np.array(model_ARIMAX_for[<span class="st">&#39;AutoARIMA&#39;</span>])</span>
<span id="cb57-2"><a href="dynamic-regression.html#cb57-2" tabindex="-1"></a>MAPE <span class="op">=</span> np.mean(<span class="bu">abs</span>(error)<span class="op">/</span>test[<span class="st">&#39;Passengers&#39;</span>])<span class="op">*</span><span class="dv">100</span></span>
<span id="cb57-3"><a href="dynamic-regression.html#cb57-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Auto. MAE =&quot;</span>, np.mean(<span class="bu">abs</span>(error)), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">Auto. MAPE =&quot;</span>, MAPE)</span></code></pre></div>
<pre><code>## Auto. MAE = 3705.2900390625 
## Auto. MAPE = 5.759043319108617</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="dynamic-regression.html#cb59-1" tabindex="-1"></a>error <span class="op">=</span> np.array(test[<span class="st">&#39;Passengers&#39;</span>]) <span class="op">-</span> np.array(model_ARIMAX_for[<span class="st">&#39;ARIMA&#39;</span>])</span>
<span id="cb59-2"><a href="dynamic-regression.html#cb59-2" tabindex="-1"></a>MAPE <span class="op">=</span> np.mean(<span class="bu">abs</span>(error)<span class="op">/</span>test[<span class="st">&#39;Passengers&#39;</span>])<span class="op">*</span><span class="dv">100</span></span>
<span id="cb59-3"><a href="dynamic-regression.html#cb59-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Hand MAE =&quot;</span>, np.mean(<span class="bu">abs</span>(error)), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">Hand MAPE =&quot;</span>, MAPE)</span></code></pre></div>
<pre><code>## Hand MAE = 1123.05859375 
## Hand MAPE = 1.7172460911949101</code></pre>
<p>Although the automatically selected ARIMA model barely beat the hand selected model in the training dataset metrics, it appears as if the ARIMA models selected by hand has both a better mean absolute error (MAE) and mean absolute percentage error (MAPE) on the test dataset.</p>
</div>
<div id="sas-6" class="section level3 hasAnchor" number="6.6.3">
<h3><span class="header-section-number">6.6.3</span> SAS<a href="dynamic-regression.html#sas-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our dataset we have a point intervention at September, 2001. We can easily create a binary variable that takes a value of 1 during that month and 0 otherwise. We also need to create a dataset that blanks out all the values of the Passenger variable past in our test window. SAS needs a dataset with the training data as well as future values of the predictor variables to forecast with dynamic regression.</p>
<p>From there we use the PROC ARIMA procedure with this newly created dataset. With the IDENTIFY statement we give our target variable with the VAR option. Remember, the (12) after the target variable signals that we want to take the seasonal difference. We also include the CROSSCORR option with our predictor variable Sep11. We include the MINIC option as well to help with order selection of the ARIMA model. We then use the ESTIMATE statement to define our model, here an ARIMA(1,0,0)(1,1,1) model. The INPUT option is where we put our Sep11 variable into the actual model. The (1,2,3,12) in front of the Sep11 variable creates what is formally called a transfer function. It creates a lag structure on the variable (essentially adding lags of that variable) at the lags of 1,2,3, and 12. We finish with the FORECAST statement with the LEAD option set to 12 to forecast the next 12 observations.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="dynamic-regression.html#cb61-1" tabindex="-1"></a>data usair_pred;</span>
<span id="cb61-2"><a href="dynamic-regression.html#cb61-2" tabindex="-1"></a>    set usair;</span>
<span id="cb61-3"><a href="dynamic-regression.html#cb61-3" tabindex="-1"></a>    Sep11 <span class="ot">=</span> <span class="dv">0</span>;</span>
<span id="cb61-4"><a href="dynamic-regression.html#cb61-4" tabindex="-1"></a>    <span class="cf">if</span> date <span class="ot">=</span> <span class="st">&#39;1sep2001&#39;</span>d then Sep11 <span class="ot">=</span> <span class="dv">1</span>;</span>
<span id="cb61-5"><a href="dynamic-regression.html#cb61-5" tabindex="-1"></a>    <span class="cf">if</span> date <span class="sc">&gt;</span> <span class="st">&#39;1mar2007&#39;</span>d then Passengers <span class="ot">=</span> .;</span>
<span id="cb61-6"><a href="dynamic-regression.html#cb61-6" tabindex="-1"></a>run;</span>
<span id="cb61-7"><a href="dynamic-regression.html#cb61-7" tabindex="-1"></a></span>
<span id="cb61-8"><a href="dynamic-regression.html#cb61-8" tabindex="-1"></a>proc arima data <span class="ot">=</span> work.usair_pred plots <span class="ot">=</span> all;</span>
<span id="cb61-9"><a href="dynamic-regression.html#cb61-9" tabindex="-1"></a>    identify var <span class="ot">=</span> <span class="fu">Passengers</span>(<span class="dv">12</span>) nlag <span class="ot">=</span> <span class="dv">24</span> crosscorr <span class="ot">=</span> (Sep11) minic P<span class="ot">=</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">15</span>) Q<span class="ot">=</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">15</span>);</span>
<span id="cb61-10"><a href="dynamic-regression.html#cb61-10" tabindex="-1"></a>    estimate p <span class="ot">=</span> (<span class="dv">1</span>)(<span class="dv">12</span>) q <span class="ot">=</span> (<span class="dv">12</span>) input <span class="ot">=</span> ((<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">12</span>)Sep11);</span>
<span id="cb61-11"><a href="dynamic-regression.html#cb61-11" tabindex="-1"></a>    forecast lead <span class="ot">=</span> <span class="dv">12</span> id <span class="ot">=</span> date interval <span class="ot">=</span> month out <span class="ot">=</span> work.ARIMAX_f;</span>
<span id="cb61-12"><a href="dynamic-regression.html#cb61-12" tabindex="-1"></a>run;</span></code></pre></div>
<div class="float">
<img src="10_e_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<div class="float">
<img src="10_f_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<div class="float">
<img src="10_g_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<p>We can check if the model produces white noise residuals by looking at the results above with the autocorrelations of the residuals and the corresponding p-values. We can also look at the white noise plot. Both of these seem to show white noise residuals.</p>
<p>We can see from the output above that our model now accounts for the outlier that we previously saw in our data. Notice how our model has changed slightly after accounting for this outlier. This will improve the forecasts going forward, even though we do not have any outliers in our test dataset.</p>
<p>Let’s look at our forecast plot from our output like we have done previously.</p>
<div class="float">
<img src="10_h_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<p>We need to isolate just the forecasted observations from the output above. For that we use the DATA STEP to just look at the predicted values from the two previous models beyond the March, 2007 training observations with the WHERE statement. Next, we use the MERGE statement in another DATA STEP to merge the original test dataset with the predicted values from the above model. Lastly, we calculate the absolute error and absolute percentage error for each observation with our last DATA STEP. To get the average of these calculations, we throw our test dataset into the PROC MEANS procedure where we specify these variables with the VAR statement.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="dynamic-regression.html#cb62-1" tabindex="-1"></a>data ARIMAX_f;</span>
<span id="cb62-2"><a href="dynamic-regression.html#cb62-2" tabindex="-1"></a>    set ARIMAX_f;</span>
<span id="cb62-3"><a href="dynamic-regression.html#cb62-3" tabindex="-1"></a>    where date <span class="sc">&gt;</span> <span class="st">&#39;1mar2007&#39;</span>d;</span>
<span id="cb62-4"><a href="dynamic-regression.html#cb62-4" tabindex="-1"></a>    Predict_ARIMAX <span class="ot">=</span> Forecast;</span>
<span id="cb62-5"><a href="dynamic-regression.html#cb62-5" tabindex="-1"></a>    keep Predict_ARIMAX;</span>
<span id="cb62-6"><a href="dynamic-regression.html#cb62-6" tabindex="-1"></a>run;</span>
<span id="cb62-7"><a href="dynamic-regression.html#cb62-7" tabindex="-1"></a></span>
<span id="cb62-8"><a href="dynamic-regression.html#cb62-8" tabindex="-1"></a>data test;</span>
<span id="cb62-9"><a href="dynamic-regression.html#cb62-9" tabindex="-1"></a>    merge test ARIMAX_f;</span>
<span id="cb62-10"><a href="dynamic-regression.html#cb62-10" tabindex="-1"></a>run;</span>
<span id="cb62-11"><a href="dynamic-regression.html#cb62-11" tabindex="-1"></a></span>
<span id="cb62-12"><a href="dynamic-regression.html#cb62-12" tabindex="-1"></a>data test;</span>
<span id="cb62-13"><a href="dynamic-regression.html#cb62-13" tabindex="-1"></a>    set test;</span>
<span id="cb62-14"><a href="dynamic-regression.html#cb62-14" tabindex="-1"></a>    AE_ARIMAX <span class="ot">=</span> <span class="fu">abs</span>(Passengers <span class="sc">-</span> Predict_ARIMAX);</span>
<span id="cb62-15"><a href="dynamic-regression.html#cb62-15" tabindex="-1"></a>    APE_ARIMAX <span class="ot">=</span> <span class="fu">abs</span>(Passengers <span class="sc">-</span> Predict_ARIMAX)<span class="sc">/</span>Passengers<span class="sc">*</span><span class="dv">100</span>;</span>
<span id="cb62-16"><a href="dynamic-regression.html#cb62-16" tabindex="-1"></a>run;</span>
<span id="cb62-17"><a href="dynamic-regression.html#cb62-17" tabindex="-1"></a></span>
<span id="cb62-18"><a href="dynamic-regression.html#cb62-18" tabindex="-1"></a>proc means data <span class="ot">=</span> test;</span>
<span id="cb62-19"><a href="dynamic-regression.html#cb62-19" tabindex="-1"></a>    var AE_ARIMAX APE_ARIMAX;</span>
<span id="cb62-20"><a href="dynamic-regression.html#cb62-20" tabindex="-1"></a>run;</span></code></pre></div>
<div class="float">
<img src="10_i_SAS.png" alt="SASOutput" />
<div class="figcaption">SASOutput</div>
</div>
<p>In the output above we can see the mean absolute error (MAE) and mean absolute percentage error (MAPE) for this new dynamic regression model with all the lags.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="seasonal-arima.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/sjsimmo2/TimeSeries/edit/master/05-DynamicRegression.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/sjsimmo2/TimeSeries/blob/master/05-DynamicRegression.Rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
